services:
  sqld:
    image: ghcr.io/tursodatabase/libsql-server:latest
    volumes:
      - sqld-data:/var/lib/sqld
    ports:
      - 8080:8080
    networks:
      - internal

  server:
    build:
      context: .
      dockerfile: Dockerfile.server
    depends_on:
      - sqld
    environment:
      - AUTH_COOKIE_DOMAIN=${AUTH_COOKIE_DOMAIN:-.colmena.dev}
      - BETTER_AUTH_SECRET=${BETTER_AUTH_SECRET}
      - BETTER_AUTH_URL=https://stack-api.colmena.dev
      - CORS_ORIGINS=https://stack.colmena.dev,solana-stack-attack://
      - DATABASE_AUTH_TOKEN=dummy-token-for-local
      - DATABASE_URL=http://sqld:8080
      - FEE_PAYER_KEYPAIR=${FEE_PAYER_KEYPAIR}
      - GOOGLE_GENERATIVE_AI_API_KEY=${GOOGLE_GENERATIVE_AI_API_KEY}
      - NODE_ENV=production
      - SOLANA_RPC_URL=https://api.devnet.solana.com
      - TOKEN_MINT_ADDRESS=8KLh3dLFgCKVkcQpgQep6e2d678uE49VdLpRcyDCWaxV
      - UMAMI_WEBSITE_ID=${UMAMI_WEBSITE_ID}
    networks:
      - internal
      - dokploy-network

  web:
    build:
      context: .
      dockerfile: Dockerfile.web
      args:
        - VITE_SERVER_URL=https://stack-api.colmena.dev
        - VITE_UMAMI_WEBSITE_ID=${VITE_UMAMI_WEBSITE_ID:-}
    depends_on:
      - server
    environment:
      - BETTER_AUTH_SECRET=${BETTER_AUTH_SECRET}
      - BETTER_AUTH_URL=https://stack-api.colmena.dev
      - CORS_ORIGINS=https://stack.colmena.dev,solana-stack-attack://
      - DATABASE_AUTH_TOKEN=dummy-token-for-local
      - DATABASE_URL=http://sqld:8080
      - NODE_ENV=production
      - VITE_SERVER_URL=https://stack-api.colmena.dev
    networks:
      - internal
      - dokploy-network

volumes:
  sqld-data:

networks:
  internal:
    driver: bridge
  dokploy-network:
    external: true
